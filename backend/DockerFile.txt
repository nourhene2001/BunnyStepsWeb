# ────────────────────────────────────────────────────────────────
# Builder stage
# ────────────────────────────────────────────────────────────────
FROM python:3.12-slim-bookworm AS builder

WORKDIR /app

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY backend/requirements*.txt ./
RUN pip install --upgrade pip && \
    pip install -r requirements-dev.txt && \
    if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

# ────────────────────────────────────────────────────────────────
# Final stage
# ────────────────────────────────────────────────────────────────
FROM python:3.12-slim-bookworm

WORKDIR /app

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Minimal runtime deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# Non-root user
RUN addgroup --system --gid 1001 app && \
    adduser --system --uid 1001 --gid 1001 app

COPY --from=builder --chown=app:app /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=builder --chown=app:app /usr/local/bin /usr/local/bin

# Copy Django code
COPY --chown=app:app backend/ .

USER app

# Optional: entrypoint for migrate + collectstatic (see below)
# COPY backend/entrypoint.sh .
# ENTRYPOINT ["/app/entrypoint.sh"]

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "BunnySteps.wsgi:application"]